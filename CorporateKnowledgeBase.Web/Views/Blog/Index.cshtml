@model IEnumerable<CorporateKnowledgeBase.Web.Models.BlogPost>

@{
    ViewData["Title"] = "All Blog Posts";
}

<h1>@ViewData["Title"]</h1>

@if (!string.IsNullOrEmpty(ViewBag.CurrentTag))
{
    <div class="alert alert-info d-flex justify-content-between align-items-center">
        <span>
            Filtered by Tag: <span class="badge bg-dark">@ViewBag.CurrentTag</span>
        </span>
        <a asp-action="Index" class="btn btn-sm btn-outline-danger">Clear Filter</a>
    </div>
}

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form id="search-form" asp-controller="Blog" asp-action="Index" method="get">
            <div class="row g-3 align-items-center">
                <div class="col-md-6">
                    <input type="text" id="search-input" name="searchString" class="form-control" placeholder="Search in title, content, or tags..." value="@ViewBag.CurrentSearchString" />
                </div>
                <div class="col-md-4">
                    <select id="category-select" name="categoryId" class="form-select" asp-items="ViewBag.Categories as SelectList">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" type="submit">Filter</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div id="blog-list-container">
    <partial name="_BlogListPartial" model="Model" />
</div>

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script>
        // AJAX
        function updateContent() {
            var searchString = $('#search-input').val();
            var categoryId = $('#category-select').val();
            var pageNumber = 1;

            $.ajax({
                url: '@Url.Action("Index", "Blog")',
                data: { searchString: searchString, categoryId: categoryId, pageNumber: pageNumber },
                type: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function (result) {
                    $('#blog-list-container').html(result);
                }
            });
        }

        // Event Listener
        $('#search-form').submit(function (e) {
            e.preventDefault();
            updateContent();
        });

        $('#category-select').change(function () {
            updateContent();
        });

        // Event listener for pagination links
        $(document).on('click', '.pagination a', function (e) {
            e.preventDefault();
            var searchString = $('#search-input').val();
            var categoryId = $('#category-select').val();
            var pageNumber = $(this).data('page');

            $.ajax({
                url: '@Url.Action("Index", "Blog")',
                data: { searchString: searchString, categoryId: categoryId, pageNumber: pageNumber },
                type: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function (result) {
                    $('#blog-list-container').html(result);
                }
            });
        });
    </script>
}